<html>
    <head>
        <meta charset="utf-8"/>
        <script src="https://code.jquery.com/jquery-latest.js"></script>
        <script src="https://robotraconteur.github.io/robotraconteur_pyodide/pyodide.js"></script>  
    </head>
    <body>
        
        <script>
        
            function print_div(message)
            {
                //$("#print_div").append("<br/>" + message +"\n")
                $("#print_div").append( message +" ")
            }         
            function print_div_j_info(message)
            {   
                var id="" 
                var angles_array = message.split("<br>");
                for (let i = 0; i < angles_array.length - 1 ; i++) {
                    id = "j" + (i+1).toString() + "_angle_out" 
                    document.getElementById(id).innerHTML = angles_array[i];
                }
            }
            function print_div_j_limit_info(message_lower, message_upper)
            {   
                var id="j1_neg_limit" 
                var lower_angles_array = message_lower.split(" ");
                for (let i = 0; i < lower_angles_array.length - 1; i++) {
                    id = "j" + (i+1).toString() + "_neg_limit" 
                    document.getElementById(id).innerHTML = lower_angles_array[i];
                }
                
                var id="j1_pos_limit" 
                var upper_angles_array = message_upper.split(" ");
                for (let i = 0; i < upper_angles_array.length -1; i++) {
                    id = "j" + (i+1).toString() + "_pos_limit" 
                    document.getElementById(id).innerHTML = upper_angles_array[i];
                }
            }
            
            function print_div_flag_info(message)
            {
                $("#print_div_flag_info").html(message)
            }
            function print_div_kin_info(message)
            {
                $("#print_div_kin_info").html(message)
            }
            function print_div_num_info(message)
            {
                $("#print_div_num_info").html(message)
            }
            function print_div_end_info(message)
            {
                $("#print_div_end_info").html(message)
            }
            function print_div_ik_info(message)
            {
                $("#print_div_ik_info").html(message)
            }

            function print_div_cur_pose(msg_orientation, msg_position)
            {
                $("#cur_ZYX_angles").html(msg_orientation)
                $("#cur_position").html(msg_position)
            }
            
            function upSelPose()
            {
                var x = document.getElementById("saved_poses_list");
                var index = x.selectedIndex
                if (index > 0) {
                  var option = x.options[index];
                  x.remove(index);
                  x.add(option,index-1)
                }
            }
            
            function downSelPose()
            {
                var x = document.getElementById("saved_poses_list");
                var index = x.selectedIndex
                if (index < x.length-1) {
                  var option = x.options[index];
                  x.remove(index);
                  x.add(option,index+1)
                }
            }
            
            function delSelPose()
            {
                var x = document.getElementById("saved_poses_list");
                x.remove(x.selectedIndex);
            }

            
            function showJointVelValue()
            {
                var slider = document.getElementById("joint_vel_range");
                var percent = document.getElementById("joint_vel_percentage");
                percent.innerHTML = slider.value;
            }
            
            
            async function run_test(){
                await languagePluginLoader;
                await pyodide.loadPackage(["numpy"]);      

                const response_zip = await fetch("./my_source.zip", {cache: "no-store"});
                // const response = await fetch("./RR-Sawyer-Client-WebBrowser-Jogging-Cartesian.py", {cache: "no-store"});

                const response = await fetch("./RR-Sawyer-Client-WebBrowser-Save-Playback-Poses.py", {cache: "no-store"});
                const client_zip = await response_zip.arrayBuffer();
                let FS = pyodide._module.FS; 
                FS.writeFile("./my_source.zip", new Uint8Array(client_zip))

                const client_py = await response.text();                
                pyodide.runPython(client_py)
            }

            run_test();
        </script>

        <H2>Sawyer Web Browser Controller Demo</H2>
        <table style="text-align: center; display: inline-block; border: 1px solid; float: left;" > <!-- border="1" > -->
            <Tr>
                <TH align="center" COLSPAN="6"> <H3>Joint Space Control</H3> </TH>
            </Tr>
            <Tr>
                <TH> <H4>Min<br>(deg)</H4></TH>
                <TH> <H4></H4></TH>
                <TH> <H4>Current<br>(deg)</H4></TH>
                <TH> <H4></H4></TH>
                <TH> <H4>Max<br>(deg)</H4></TH>
                <TH> <H4>Angle Input<br>(deg)</H4></TH>
            </Tr>
            <tr>
                <td> <div align="center" id="j1_neg_limit"> N/A </div> </td>
                <td> <button id="j1_neg_btn" type="button">J1-</button></td>
                <td> <div align="center" id="j1_angle_out"> N/A </div> </td>
                <td> <button id="j1_pos_btn" type="button">J1+</button></td>
                <td> <div align="center" id="j1_pos_limit"> N/A </div> </td>
                <td> <input type="text" id="j1_angle_in" placeholder="deg_j1" value="0" style="text-align:center; font-size: 16px;"> </td>
            </tr>
            <tr>
                <td> <div align="center" id="j2_neg_limit"> N/A </div> </td>
                <td> <button id="j2_neg_btn" type="button">J2-</button></td>
                <td> <div align="center" id="j2_angle_out"> N/A </div> </td>
                <td> <button id="j2_pos_btn" type="button">J2+</button></td>
                <td> <div align="center" id="j2_pos_limit"> N/A </div> </td>
                <td> <input type="text" id="j2_angle_in" placeholder="deg_2" value="0" style="text-align:center; font-size: 16px;"> </td>
            </tr>         
            <tr>
                <td> <div align="center" id="j3_neg_limit"> N/A </div> </td>
                <td> <button id="j3_neg_btn" type="button">J3-</button></td>
                <td> <div align="center" id="j3_angle_out"> N/A </div> </td>
                <td> <button id="j3_pos_btn" type="button">J3+</button></td>
                <td> <div align="center" id="j3_pos_limit"> N/A </div> </td>
                <td> <input type="text" id="j3_angle_in" placeholder="deg_j3" value="0" style="text-align:center; font-size: 16px;"> </td>
            </tr>      
            <tr>
                <td> <div align="center" id="j4_neg_limit"> N/A </div> </td>
                <td> <button id="j4_neg_btn" type="button">J4-</button></td>
                <td> <div align="center" id="j4_angle_out"> N/A </div> </td>
                <td> <button id="j4_pos_btn" type="button">J4+</button></td>
                <td> <div align="center" id="j4_pos_limit"> N/A </div> </td>
                <td> <input type="text" id="j4_angle_in" placeholder="deg_j4" value="0" style="text-align:center; font-size: 16px;"> </td>
            </tr>  
            <tr>
                <td> <div align="center" id="j5_neg_limit"> N/A </div> </td>
                <td> <button id="j5_neg_btn" type="button">J5-</button></td>
                <td> <div align="center" id="j5_angle_out"> N/A </div> </td>
                <td> <button id="j5_pos_btn" type="button">J5+</button></td>
                <td> <div align="center" id="j5_pos_limit"> N/A </div> </td>
                <td> <input type="text" id="j5_angle_in" placeholder="deg_j5" value="0" style="text-align:center; font-size: 16px;"> </td>
            </tr>               
            <tr>
                <td> <div align="center" id="j6_neg_limit"> N/A </div> </td>
                <td> <button id="j6_neg_btn" type="button">J6-</button></td>
                <td> <div align="center" id="j6_angle_out"> N/A </div> </td>
                <td> <button id="j6_pos_btn" type="button">J6+</button></td>
                <td> <div align="center" id="j6_pos_limit"> N/A </div> </td>
                <td> <input type="text" id="j6_angle_in" placeholder="deg_j6" value="0" style="text-align:center; font-size: 16px;"> </td>
            </tr>
            <tr>
                <td> <div align="center" id="j7_neg_limit"> N/A </div> </td>
                <td> <button id="j7_neg_btn" type="button">J7-</button></td>
                <td> <div align="center" id="j7_angle_out"> N/A </div> </td>
                <td> <button id="j7_pos_btn" type="button">J7+</button></td>
                <td> <div align="center" id="j7_pos_limit"> N/A </div> </td>
                <td> <input type="text" id="j7_angle_in" placeholder="deg_j7" value="0" style="text-align:center; font-size: 16px;"> </td>
            </tr>
            <tr>
                <td> </td>
                <td> </td>
                <td> </td>
                <td> </td>
                <td> </td>
                <td> <button id="j_angles_submit_btn" type="button">Move to angles!</button> </td>
            </tr>
            <tr>
                <td COLSPAN="6"> <button id="stop_btn" type="button" style="width: 100%;">STOP! </button> </td>
            </tr>
        </table>
                <!-- style="display: inline-block; border: 1px solid; float: left; " -->
        <table style="text-align: center; display: inline-block; border: 1px solid; float: left; " >
            <Tr>
                <TH align="center" COLSPAN="2"> <H3>Task Space Control</H3> </TH>
            </Tr>
            <Tr>
                <TH align="center" COLSPAN="2"> <H4>Position</H4> </TH>
            </Tr>
            <tr>
                <td> <button id="X_neg_btn" type="button">X-</button> </td>
                <td> <button id="X_pos_btn" type="button">X+</button> </td>
            </tr>
            <tr>
                <td> <button id="Y_neg_btn" type="button">Y-</button> </td>
                <td> <button id="Y_pos_btn" type="button">Y+</button> </td>
            </tr>         
            <tr>
                <td> <button id="Z_neg_btn" type="button">Z-</button> </td>
                <td> <button id="Z_pos_btn" type="button">Z+</button> </td>
            </tr>
            <Tr>
                <TH align="center" COLSPAN="2"> <H4><br>Orientation</H4> </TH>
            </Tr>      
            <tr>
                <td> <button id="theta_X_neg_btn" type="button">&theta;<sub>X</sub>-</button> </td>
                <td> <button id="theta_X_pos_btn" type="button">&theta;<sub>X</sub>+</button> </td>
            </tr>  
            <tr>
                <td> <button id="theta_Y_neg_btn" type="button">&theta;<sub>Y</sub>-</button> </td>
                <td> <button id="theta_Y_pos_btn" type="button">&theta;<sub>Y</sub>+</button> </td>
            </tr>
            <tr>
                <td>  <button id="theta_Z_neg_btn" type="button">&theta;<sub>Z</sub>-</button> </td>
                <td> <button id="theta_Z_pos_btn" type="button">&theta;<sub>Z</sub>+</button> </td>
            </tr>
            <tr>
                <td COLSPAN="2">
                <table style="text-align: center; display: inline-block; border: 1px solid; ">
                    <Tr> <TH align="center"> <H4>Current Pose wrt Base</H4> </TH> </Tr>
                    <tr> <td align="left"> ZYX Angles (deg):  </td> </tr>
                    <tr> <td> <div align="left" id="cur_ZYX_angles"></div> </td></tr>
                    <tr> <td align="left"> Position (m): </td> </tr>
                    <tr> <td> <div align="left" id="cur_position"></div>  </td></tr>    
                </table>
                <td>
            </tr>
            
            
        </table>
        
        <table style="text-align: center; display: inline-block; border: 1px solid; float: left;" border="1"> 
            <Tr>
                <TH align="center" COLSPAN="3"> <H3>Save & Playback Poses</H3> </TH>
            </Tr>
            <Tr>
                <TH align="center" COLSPAN="3"> <H4>Saved Poses</H4> </TH>
            </Tr>
                 
            <tr>
                <td COLSPAN="3"> <!-- <ul id="ss_imp_list" tabindex="0" role="listbox" >
                          <li id="ss_opt1" role="option"> Hello1 </li>
                          <li id="ss_opt2" role="option"> Hello2 </li> 
                      </ul> -->
                      <select id="saved_poses_list" name="saved_poses_list" size="5" multiple style="width: 100%; font-size: 16px;">
                        <option value="0,0,0,0,0,0,0">0,0,0,0,0,0,0</option>
                      </select>
                </td>    
            </tr>
            
            <tr>
                <td COLSPAN="3"> <button id="save_pose_btn" type="button" style="width: 100%;">SAVE Current Pose</button> </td>
            </tr>
            <tr>
                <td COLSPAN="3"> <button id="up_sel_pose_btn" type="button" style="width: 100%;" onclick="upSelPose()">Move UP Selected Pose</button> </td>
            </tr>
            <tr>
                <td COLSPAN="3"> <button id="down_sel_pose_btn" type="button" style="width: 100%;" onclick="downSelPose()">Move DOWN Selected Pose</button> </td>
            </tr>
            <tr>
                <td COLSPAN="3"> <button id="del_sel_pose_btn" type="button" style="width: 100%;" onclick="delSelPose()">REMOVE Selected Pose</button> </td>
            </tr>
            <tr>
                <td COLSPAN="3"> <button id="go_sel_pose_btn" type="button" style="width: 100%;">GO to Selected Pose</button> </td>
            </tr>
            <tr>
                <td> Speed (%): </td> 
                <td> <input id="joint_vel_range" type="range" min="0" max="100" value="100" step="5" 
                    oninput="showJointVelValue()" onchange="showJointVelValue()"> </td>
                <td style="width: 35px;" > <div align="center" id="joint_vel_percentage"> N/A </div> </td> 
            </tr>
            <tr>
                <td COLSPAN="2"> Number of Loops: </td> 
                <td> <input type="number" id="num_loops_in" placeholder="number of loops" value="1" min="1" style="text-align:center; font-size: 16px;"> </td>
            </tr>
            <tr>
                <td COLSPAN="2"> Loop Time (s): </td> 
                <td> <input type="number" id="time_loops_in" placeholder="1 Loop time when speed is 100%" value="3.0" min="0" step="0.001" style="text-align:center; font-size: 16px;"> </td>
            </tr>
            <tr>
                 <td COLSPAN="3"> <button id="playback_poses_btn" type="button" style="width: 100%;">PLAYBACK Saved Poses!</button> </td>
            </tr>
        </table>
                
        <table style="text-align: right" border="5"  WIDTH="100%"   > <!-- CELLPADDING="4" CELLSPACING="3"> -->
            <Tr>
                <TH align="center" COLSPAN="2">
                    <H3><BR> Robot Status</H3>
                </TH>
            </Tr>
            
            <tr>              
                <TH> Robot State Flags: </TH>
                <td>
                    <div align="left" id="print_div_flag_info"></div>
                </td>
            </tr>
            
            <tr>              
                <TH>Joint Kinematic Info: </TH>
                <td>
                    <div align="left" id="print_div_kin_info"></div>
                </td>
            </tr>
            
            
            <tr>              
                <TH>Number of Joints:<br>
                    Joints Types (0:unkown, 1:revolute, 2:continuous, 3:prismatic, 4:wheel):<br>
                    Joint Velocity Limits:<br>
                    Joint Acceleration Limits:<br>
                    Joint Names: <!--<br>
                    Joint UUID's: -->
                </TH>
                <td>
                    <div align="left" id="print_div_num_info"></div>
                </td>
            </tr>
            
            <tr>              
                <TH>End Effector Pose (wrt. Base Frame): </TH>
                <td>
                    <div align="left" id="print_div_end_info"></div>
                </td>
            </tr>
            
            <tr>              
                <TH>Desired Pose:<br>
                    Desired Inverse Kinematics Joint Angles (deg, rad):<br>
                    Is IK Solution Converged:
                </TH>
                <td>
                    <div align="left" id="print_div_ik_info"></div>
                </td>
            </tr>
        </table>
        
        
        
        <div id="print_div"></div>  
        
    </body>
</html>
